<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,400italic" rel="stylesheet" type="text/css"><link rel="stylesheet" type="text/css" href="/assets/css/style.min.css"><title>Pike string functions - some interesting tidbits</title><meta name="description" content="Which string functions are faster"><meta name="keywords" content=""></head><body class="article"><header><div class="container"><h1><a href="/"><img src="/assets/img/profile2.jpg" alt="Portait of Pontus"> <span class="text">Pontus Östlund</span> <span class="tagline">Caught in a web</span></a></h1></div></header><div class="container extra-margin-bottom"><div class="row"><div class="col-md-10"><h2>Pike string functions and some interesting tidbits!</h2><p class="pubdate">May 21, 2016</p><p>The other day we got a support ticket at work from one of our partners. The developer had some issues getting his code working and had exemplary attached the code he had problems with. And in this code I spotted something, which had nothing to do with his problem, that caught my interest.</p><p>In the code some string matching was done, and with a function I have hardly ever seen beeing used in Pike. The function was <code>String.count()</code>. Now, this function admittedly serves its purpose, but in this case it was just a matter of checking if a string started with <code>/__uuid/</code>.</p><p>So I got interested in finding out how much slower <code>String.count()</code> is compared to <code>search()</code> and <code>has_prefix()</code>, because I was at beforehand pretty sure <code>String.count()</code> would be slower. In our partner's defence I would like to add that in this particular case execution speed was of no concern since the method the code was in only get run once or twice occationally.</p><p>So I wrote a little test to test the speed of these three functions. The test looks like (in pseudo code):</p><pre><code>string s = "/__uuid/32311eec-930e-4ace-abe3-c9f73529fb0a/index.xml";

while *counter* is less than a *hundred million*
  with *method* test if *s* starts with */__uuid/*</code></pre><p>This is the test program</p><pre><code><span class="macro">#define</span> RUN<span class="delim">(</span>METHOD<span class="delim">,</span> CMP<span class="delim">,</span> VAL<span class="delim">)</span>                  \
  <span class="lang">do</span> <span class="delim">{</span>                                         \
    t <span class="delim">=</span> 0<span class="delim">;</span>                                     \
    g <span class="delim">=</span> <span class="lang">gauge</span> <span class="delim">{</span>                                \
      <span class="lang">for</span> <span class="delim">(</span><span class="type">int</span> i <span class="delim">=</span> 0<span class="delim">;</span> i <span class="delim">&lt;</span> 100000000<span class="delim">;</span> i++<span class="delim">)</span> <span class="delim">{</span>    \
        <span class="lang">if</span> <span class="delim">(</span>METHOD<span class="delim">(</span>s<span class="delim">,</span> <span class="string">"/__uuid/"</span><span class="delim">)</span> CMP VAL<span class="delim">)</span> <span class="delim">{</span>   \
          t += 1<span class="delim">;</span>                              \
        <span class="delim">}</span>                                      \
      <span class="delim">}</span>                                        \
    <span class="delim">}</span><span class="delim">;</span>                                         \
    write<span class="delim">(</span><span class="string">"%-15s: %.2fs\n"</span><span class="delim">,</span> #METHOD<span class="delim">,</span> g<span class="delim">)</span><span class="delim">;</span>       \
  <span class="delim">}</span> <span class="lang">while</span> <span class="delim">(</span>0<span class="delim">)</span>

<span class="type">int</span> main<span class="delim">(</span><span class="type">int</span> argc<span class="delim">,</span> <span class="type">array</span><span class="delim">(</span><span class="type">string</span><span class="delim">)</span> argv<span class="delim">)</span>
<span class="delim">{</span>
  <span class="type">string</span> s <span class="delim">=</span> <span class="string">"/__uuid/"</span> <span class="delim">+</span> <span class="delim">(</span><span class="delim">(</span><span class="type">string</span><span class="delim">)</span><span class="ns">Standards</span><span class="delim">.</span>UUID<span class="delim">.</span>make_version4<span class="delim">(</span><span class="delim">)</span><span class="delim">)</span> <span class="delim">+</span> <span class="string">"/index.xml"</span><span class="delim">;</span>

  write<span class="delim">(</span><span class="string">"Testing string: %O\n\n"</span><span class="delim">,</span> s<span class="delim">)</span><span class="delim">;</span>

  <span class="type">float</span> g<span class="delim">;</span>
  <span class="type">int</span> t<span class="delim">;</span>

  RUN<span class="delim">(</span><span class="ns">String</span><span class="delim">.</span>count<span class="delim">,</span> <span class="delim">&gt;</span><span class="delim">,</span> 0<span class="delim">)</span><span class="delim">;</span>
  RUN<span class="delim">(</span>search<span class="delim">,</span>       <span class="delim">&gt;</span><span class="delim">,</span> <span class="delim">-</span>1<span class="delim">)</span><span class="delim">;</span>
  RUN<span class="delim">(</span>has_prefix<span class="delim">,</span>  ==<span class="delim">,</span> <span class="const">true</span><span class="delim">)</span><span class="delim">;</span>

  <span class="lang">return</span> 0<span class="delim">;</span>
<span class="delim">}</span></code></pre><p>The result of this is propably not too surprising. <code>has_prefix()</code> is way faster since that function doesn't need to scan the entire string and can thus abort early. On my machine the result was as follows:</p><pre><code>Testing string: "/__uuid/51a85c99-3ead-4cd2-a0dd-8825066a23c8/index.xml"

String.count   : 12.21s
search         : 5.40s
has_prefix     : 2.13s</code></pre><p>So if performance is of interest one should learn which string function to use for every given case, it can have great impact on the performance.</p><p>Another interesting thing I noticed. At first I didn't have the <code>t += 1</code> inside of the <code>if</code> block. The code finished immediately which led me to the conclusion that the Pike compiler saw the <code>if</code> block was dead code and thus removed it completley.</p></div></div></div><footer><div class="container"><div class="row"><div class="col-sm-6"><p><strong>Pontus Östlund</strong></p><ul class="follow"><li><a href="https://github.com/poppa"><i class="fa fa-github"></i> Github</a></li><li><a href="https://instagram.com/poppanator"><i class="fa fa-instagram"></i> Instagram</a></li><li><a href="https://www.linkedin.com/in/poppanator"><i class="fa fa-linkedin"></i> LinkedIn</a></li></ul></div></div></div></footer><script src="/assets/js/vendor.min.js"></script><script src="/assets/js/app.min.js"></script></body></html>